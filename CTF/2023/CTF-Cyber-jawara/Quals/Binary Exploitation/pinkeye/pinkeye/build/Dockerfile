FROM ubuntu:22.04 AS builder

ARG DEBIAN_FRONTEND=noninteractive

WORKDIR /build

COPY nocheese.patch .

RUN apt-get update && \
    apt-get install gcc make git -qy

RUN git clone https://github.com/jart/blink && \
    cd blink && \
    git checkout fcccd950463ee5bd11d302a24d54ed6787d1eb58 && \
    git apply ../nocheese.patch && \
    ./configure CFLAGS=-flto LDFLAGS=-s && \
    make -j$(nproc) MODE=tiny

FROM scratch AS release
COPY --from=builder /build/blink/o/tiny/blink/blink /
